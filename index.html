<script>
    const consola = document.getElementById('console');
    const editor = document.getElementById('editor');
    const jsonExt = document.getElementById('json-ext');

    window.imprimir = (t) => {
        if(consola.innerText.includes("Consola Cluaray")) consola.innerText = "";
        consola.innerText += t + "\n";
    };

    function ejecutar() {
        consola.innerText = "";
        let raw = editor.value;

        // 1. Aplicar Plugins JSON (Sincronizado)
        try {
            const ext = JSON.parse(jsonExt.value);
            for (let [p, l] of Object.entries(ext)) {
                raw = raw.replace(new RegExp(`\\b${p}\\b`, 'g'), l);
            }
        } catch(e) {}

        // 2. Traducción Espejo
        let c = raw.replace(/\btarea\s+/g, 'function ').replace(/\bdato\s+/g, 'local ')
                   .replace(/\bfin\b/g, 'end').replace(/\bsi\s+/g, 'if ')
                   .replace(/\bentonces\b/g, 'then').replace(/\blista\s+/g, 'local ')
                   .replace(/\[/g, '{').replace(/\]/g, '}');
        
        c = c.replace(/f"(.*?)\{(.*?)\}(.*?)"/g, (m, p1, p2, p3) => {
            return `"${p1}" .. tostring(${p2}) .. "${p3}"`;
        });
        
        c = c.replace(/\bver\s+(.*)/g, 'print($1)');
        
        const helper = `print = function(...) local args = {...} for i, v in ipairs(args) do js.global:imprimir(tostring(v)) end end `;
        
        try { fengari.load(helper + c)(); } catch (e) { consola.innerText = "❌ ERROR: " + e; }
    }
</script>
